<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <RunBuildTasks Condition="'$(RunBuildTasks)' == ''">false</RunBuildTasks>
    <VersionFile Condition="'$(VersionFile)' == ''">Properties/Version.txt</VersionFile>
    <InputFile Condition="'$(InputFile)' == ''">Properties/GlobalAssemblyInfoTemplate.cs</InputFile>
    <OutputFile Condition="'$(OutputFile)' == ''">Properties/GlobalAssemblyInfo.cs</OutputFile>
    <Version></Version>
    <DescriptionFile Condition="'$(DescriptionFile)' == ''">$(ProjectDir)..\..\doc\ReleaseNotes.txt</DescriptionFile>
  </PropertyGroup>

  <!-- https://stackoverflow.com/a/3405932/1511066 -->
  <Target Name="ExecRunBuildTasks" BeforeTargets="CoreCompile" Outputs="dummy.file">
    <Message Text="Running custom build tasks..." Importance="High" />
    <Exec Command="&quot;$(MSBuildBinPath)\MSBuild.exe&quot; /t:RunBuildTasks /p:RunBuildTasks=true /p:Configuration=$(Configuration) &quot;$(ProjectDir)$(ProjectFileName)&quot;" />
  </Target>

  <Target Name="RunBuildTasks" Condition="$(RunBuildTasks)">
    <CallTarget Targets="UpdateVersion" />
    <CallTarget Targets="CreateUpdateManifests" />
  </Target>

  <UsingTask TaskName="UpdateAssemblyVersion" AssemblyFile="$(ProjectDir)..\Micser.BuildTasks\bin\$(Configuration)\Micser.BuildTasks.dll" />
  <UsingTask TaskName="CreateUpdateManifest" AssemblyFile="$(ProjectDir)..\Micser.BuildTasks\bin\$(Configuration)\Micser.BuildTasks.dll" />

  <Target Name="UpdateVersion">
    <UpdateAssemblyVersion InputFileName="$(InputFile)" OutputFileName="$(OutputFile)" VersionFileName="$(VersionFile)" Version="$(Version)">
      <Output TaskParameter="Version" PropertyName="Version" />
    </UpdateAssemblyVersion>
  </Target>

  <Target Name="CreateUpdateManifests">
    <CreateUpdateManifest DescriptionFileName="$(DescriptionFile)" OutputFileName="$(ProjectDir)..\..\bin\manifest-x64.json" Version="$(Version)" />
    <CreateUpdateManifest DescriptionFileName="$(DescriptionFile)" OutputFileName="$(ProjectDir)..\..\bin\manifest-x86.json" Version="$(Version)" />
  </Target>
</Project>